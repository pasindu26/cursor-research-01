# Water360 Database Setup Guide

This guide provides detailed instructions for setting up the MySQL database on a dedicated EC2 instance for the Water360 application.

## Table of Contents
- [Prerequisites](#prerequisites)
- [Directory Structure](#directory-structure)
- [Deployment Process](#deployment-process)
- [Handling Existing MySQL Installations](#handling-existing-mysql-installations)
- [Security Considerations](#security-considerations)
- [Monitoring and Maintenance](#monitoring-and-maintenance)
- [Troubleshooting](#troubleshooting)

## Prerequisites

Before proceeding with the deployment, ensure you have:

- SSH access to the EC2 instance (IP: 52.54.100.68)
- SSH key file (KP-NV-ESIS-01.pem)
- Your backend server's IP address
- Sudo privileges on the EC2 instance

## Directory Structure

```
database/
├── config/
│   └── db.conf              # Database configuration
├── schema/
│   └── init.sql            # Database schema and initial data
├── scripts/
│   ├── mysql_server_setup.sh   # Installation and setup script
│   ├── mysql_backup.sh         # Backup script
│   ├── mysql_monitor.sh        # Monitoring script
│   └── test_connection.py      # Connection testing script
└── README.md               # This file
```

## Deployment Process

### 1. Prepare the EC2 Instance

First, create the necessary directories on the EC2 instance:

```bash
# Connect to the EC2 instance
ssh -i KP-NV-ESIS-01.pem ubuntu@52.54.100.68

# Create the directory structure
mkdir -p ~/water360/database/{config,schema,scripts}
```

### 2. Transfer Required Files

From your development machine, use SCP to transfer only the necessary files:

```bash
# Navigate to your backend directory
cd path/to/backend

# Transfer files (run these commands on your development machine)
scp -i KP-NV-ESIS-01.pem backend/database/config/db.conf ubuntu@52.54.100.68:~/water360/database/config/
scp -i KP-NV-ESIS-01.pem backend/database/schema/init.sql ubuntu@52.54.100.68:~/water360/database/schema/
scp -i KP-NV-ESIS-01.pem backend/database/scripts/* ubuntu@52.54.100.68:~/water360/database/scripts/
```

### 3. Configure the Database

On the EC2 instance:

```bash
# Connect to the EC2 instance
ssh -i KP-NV-ESIS-01.pem ubuntu@52.54.100.68

# Navigate to the database directory
cd ~/water360/database

# Update configuration
nano config/db.conf

# Important: Update these values in db.conf:
# - BACKEND_IP=<Your Backend Server IP>
# - Adjust performance settings if needed
```

### 4. Run the Setup Script

```bash
# Make scripts executable
chmod +x scripts/*.{sh,py}

# Run the setup script
sudo ./scripts/mysql_server_setup.sh
```

The setup script will:
- Install MySQL Server
- Configure security settings
- Create the database and users
- Set up the schema
- Configure remote access
- Set up the firewall

### 5. Verify the Installation

```bash
# Test the database connection
./scripts/test_connection.py
```

### 6. Set Up Monitoring and Backups

```bash
# Create logs directory
mkdir -p ~/water360/database/logs

# Set up cron jobs for automated monitoring and backups
crontab -e

# Add these lines:
0 2 * * * ~/water360/database/scripts/mysql_backup.sh > ~/water360/database/logs/backup.log 2>&1
0 * * * * ~/water360/database/scripts/mysql_monitor.sh > ~/water360/database/logs/monitor.log 2>&1
```

## Handling Existing MySQL Installations

If MySQL is already installed on your EC2 instance, the setup script will detect this and handle it appropriately:

### Fresh Installation (No Root Password)
If MySQL was just installed and has no root password set, the script will:
- Set the root password to the value in db.conf
- Configure security settings
- Create the database and users

### Existing Installation (With Root Password)
If MySQL is already installed and has a root password set, the script will:
- Prompt you for the current root password
- Update the root password to the value in db.conf
- Configure security settings
- Create the database and users

### Complete Reset (If Needed)
If you want to completely reset MySQL and start fresh:

```bash
# Stop MySQL
sudo systemctl stop mysql

# Remove existing MySQL data (CAUTION: This will delete all databases!)
sudo rm -rf /var/lib/mysql/*

# Start MySQL
sudo systemctl start mysql

# Run the setup script
sudo ./scripts/mysql_server_setup.sh
```

## Security Considerations

1. **Firewall Configuration**
   - Only ports 22 (SSH) and 3306 (MySQL) should be open
   - MySQL port should only accept connections from your backend server IP

2. **User Management**
   - Use strong passwords (automatically generated by setup script)
   - Regularly rotate passwords
   - Keep the credentials.conf file secure

3. **Access Control**
   - Never enable root remote access
   - Use specific database users with limited privileges
   - Regularly audit user permissions

4. **Data Protection**
   - Enable SSL for database connections
   - Regularly update security patches
   - Monitor logs for suspicious activity

## Monitoring and Maintenance

### Daily Tasks
- Check monitoring logs
- Verify backup completion
- Monitor disk space

### Weekly Tasks
- Review slow query logs
- Check for security updates
- Analyze performance metrics

### Monthly Tasks
- Rotate database logs
- Review user permissions
- Test backup restoration

## Troubleshooting

### Common Issues

1. **Access Denied for Root User**
   ```
   ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: NO)
   ```
   
   **Solution**: MySQL already has a password set. Use the updated script which will prompt for the current password, or reset MySQL completely (see "Complete Reset" section).

2. **Connection Refused**
   ```bash
   # Check if MySQL is running
   sudo systemctl status mysql
   
   # Check firewall status
   sudo ufw status
   ```

3. **Permission Denied**
   ```bash
   # Verify user privileges
   mysql -u water360user -p
   SHOW GRANTS;
   ```

4. **Performance Issues**
   ```bash
   # Check system resources
   top
   
   # Check MySQL status
   ./scripts/mysql_monitor.sh
   ```

### Log Locations
- MySQL Error Log: `/var/log/mysql/error.log`
- Slow Query Log: `/var/log/mysql/mysql-slow.log`
- Monitor Logs: `~/water360/database/logs/monitor.log`
- Backup Logs: `~/water360/database/logs/backup.log`

### Getting Help
1. Check the error logs first
2. Review MySQL documentation
3. Contact the development team
4. Check AWS EC2 status page

## Backup and Recovery

### Manual Backup
```bash
# Create a manual backup
./scripts/mysql_backup.sh

# List available backups
ls -l ~/mysql_backups/
```

### Restore from Backup
```bash
# Latest backup
zcat ~/mysql_backups/latest.sql.gz | mysql -u root -p water360

# Specific backup
zcat ~/mysql_backups/water360_YYYY-MM-DD_HH-MM-SS.sql.gz | mysql -u root -p water360
```

## Performance Tuning

The default configuration in `db.conf` is optimized for a medium-sized EC2 instance. Adjust these values based on your server's resources:

```bash
# Memory settings
innodb_buffer_pool_size = 256M    # Adjust to 50-70% of available RAM
query_cache_size = 32M            # Increase if many identical queries

# Connection settings
max_connections = 100             # Adjust based on concurrent users
thread_cache_size = 8             # Increase if high connection rate
```

## Additional Resources

- [MySQL Documentation](https://dev.mysql.com/doc/)
- [AWS EC2 Documentation](https://docs.aws.amazon.com/ec2/)
- [MySQL Security Best Practices](https://dev.mysql.com/doc/refman/8.0/en/security.html) 